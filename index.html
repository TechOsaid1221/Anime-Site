<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coin Boost PK - Buy Gaming Currency</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        :root {
            --primary-color: #ff4500; /* Orange-Red for gaming feel */
            --secondary-color: #1e1e2f; /* Dark background */
            --card-color: #2a2a3e;
            --text-color: #ffffff;
            --button-hover: #e03c00;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--secondary-color);
            color: var(--text-color);
            padding-top: 56px; /* Space for fixed navbar */
        }

        .navbar {
            background-color: #1a1a25;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }

        .btn-primary-gaming {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            font-weight: 600;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .btn-primary-gaming:hover {
            background-color: var(--button-hover);
            border-color: var(--button-hover);
            transform: translateY(-1px);
            box-shadow: 0 4px 10px rgba(255, 69, 0, 0.4);
        }

        .product-card {
            background-color: var(--card-color);
            border: 1px solid #3c3c54;
            border-radius: 12px;
            overflow: hidden;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            height: 100%; /* Ensure all cards in a row are same height */
        }

        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.5);
        }

        .product-image {
            height: 120px;
            background-color: #35354a;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            color: var(--primary-color);
        }

        .price-tag {
            font-size: 1.5rem;
            font-weight: 800;
            color: #4CAF50; /* Green for price */
        }

        .pkr {
            font-size: 0.9rem;
            opacity: 0.8;
            margin-right: 5px;
        }

        .hero-section {
            background: linear-gradient(135deg, #1a1a25, #2a2a3e);
            padding: 4rem 0;
            margin-bottom: 3rem;
            border-bottom: 3px solid var(--primary-color);
        }

        /* Responsive adjustments for mobile */
        @media (max-width: 576px) {
            .hero-section {
                padding: 2rem 0;
            }
            .product-card {
                margin-bottom: 1.5rem;
            }
            .price-tag {
                font-size: 1.2rem;
            }
        }
    </style>
</head>
<body>

    <div class="modal fade" id="statusModal" tabindex="-1" aria-labelledby="statusModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content bg-dark text-white" style="border-radius: 12px; border: 2px solid var(--primary-color);">
                <div class="modal-header border-0 pb-0">
                    <h5 class="modal-title" id="statusModalLabel">Message</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body pt-2" id="statusModalBody">
                    </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-primary-gaming" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <nav class="navbar navbar-expand-lg fixed-top" data-bs-theme="dark">
        <div class="container">
            <a class="navbar-brand fw-bold" href="#">
                <i class="fas fa-gamepad text-danger me-2"></i>Coin Boost <span class="badge bg-danger">PK</span>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link active" aria-current="page" href="#products">Products</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">Support</a>
                    </li>
                    <li class="nav-item">
                        <button id="authButton" class="btn btn-primary-gaming ms-lg-3 mt-2 mt-lg-0" onclick="handleAuth()">
                            <i class="fab fa-google"></i> Sign In
                        </button>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <header class="hero-section text-center">
        <div class="container">
            <h1 class="display-4 fw-bolder text-white">Your Source for Gaming Power in Pakistan</h1>
            <p class="lead text-muted mt-3">Top-ups for all your favorite games, delivered instantly and securely in PKR.</p>
            <div id="authStatus" class="mt-4 p-3 rounded-3" style="background-color: rgba(255, 69, 0, 0.1);">
                <span id="welcomeMessage" class="fw-semibold">Connect your Google account to save your purchase history!</span>
            </div>
        </div>
    </header>

    <main class="container" id="products">
        <h2 class="text-center mb-5 fw-bold text-primary">Featured Currency Packs</h2>
        <div class="row row-cols-2 row-cols-md-3 row-cols-lg-4 g-4">
            <div class="col">
                <div class="product-card text-center p-3">
                    <div class="product-image rounded-3 mb-3">
                        <i class="fas fa-crown"></i>
                    </div>
                    <h5 class="fw-bold">PUBG Mobile</h5>
                    <p class="text-muted">600 UC (Elite Pack)</p>
                    <div class="price-tag mb-3">
                        <span class="pkr">PKR</span> 1,900
                    </div>
                    <button class="btn btn-primary-gaming w-100" data-product="PUBG_600UC" onclick="purchaseProduct('PUBG 600 UC')">Buy Now</button>
                </div>
            </div>

            <div class="col">
                <div class="product-card text-center p-3">
                    <div class="product-image rounded-3 mb-3">
                        <i class="fas fa-gem"></i>
                    </div>
                    <h5 class="fw-bold">Free Fire</h5>
                    <p class="text-muted">1000 Diamonds</p>
                    <div class="price-tag mb-3">
                        <span class="pkr">PKR</span> 3,100
                    </div>
                    <button class="btn btn-primary-gaming w-100" data-product="FF_1000DM" onclick="purchaseProduct('Free Fire 1000 Diamonds')">Buy Now</button>
                </div>
            </div>

            <div class="col">
                <div class="product-card text-center p-3">
                    <div class="product-image rounded-3 mb-3">
                        <i class="fas fa-bomb"></i>
                    </div>
                    <h5 class="fw-bold">Valorant</h5>
                    <p class="text-muted">1750 VP (Points)</p>
                    <div class="price-tag mb-3">
                        <span class="pkr">PKR</span> 4,500
                    </div>
                    <button class="btn btn-primary-gaming w-100" data-product="VALO_1750VP" onclick="purchaseProduct('Valorant 1750 VP')">Buy Now</button>
                </div>
            </div>

            <div class="col">
                <div class="product-card text-center p-3">
                    <div class="product-image rounded-3 mb-3">
                        <i class="fas fa-bullseye"></i>
                    </div>
                    <h5 class="fw-bold">COD Mobile</h5>
                    <p class="text-muted">800 CP Bundle</p>
                    <div class="price-tag mb-3">
                        <span class="pkr">PKR</span> 1,300
                    </div>
                    <button class="btn btn-primary-gaming w-100" data-product="CODM_800CP" onclick="purchaseProduct('COD Mobile 800 CP')">Buy Now</button>
                </div>
            </div>

            <div class="col">
                <div class="product-card text-center p-3">
                    <div class="product-image rounded-3 mb-3">
                        <i class="fas fa-globe-asia"></i>
                    </div>
                    <h5 class="fw-bold">Genshin Impact</h5>
                    <p class="text-muted">330 Crystals</p>
                    <div class="price-tag mb-3">
                        <span class="pkr">PKR</span> 1,500
                    </div>
                    <button class="btn btn-primary-gaming w-100" data-product="GEN_330CRY" onclick="purchaseProduct('Genshin Impact 330 Crystals')">Buy Now</button>
                </div>
            </div>

            <div class="col">
                <div class="product-card text-center p-3">
                    <div class="product-image rounded-3 mb-3">
                        <i class="fas fa-cubes"></i>
                    </div>
                    <h5 class="fw-bold">Roblox</h5>
                    <p class="text-muted">400 Robux Card</p>
                    <div class="price-tag mb-3">
                        <span class="pkr">PKR</span> 1,200
                    </div>
                    <button class="btn btn-primary-gaming w-100" data-product="ROB_400RBUX" onclick="purchaseProduct('Roblox 400 Robux')">Buy Now</button>
                </div>
            </div>
            
            <div class="col">
                <div class="product-card text-center p-3">
                    <div class="product-image rounded-3 mb-3">
                        <i class="fas fa-futbol"></i>
                    </div>
                    <h5 class="fw-bold">EA FC Mobile</h5>
                    <p class="text-muted">1300 FC Points</p>
                    <div class="price-tag mb-3">
                        <span class="pkr">PKR</span> 2,800
                    </div>
                    <button class="btn btn-primary-gaming w-100" data-product="FC_1300PTS" onclick="purchaseProduct('EA FC Mobile 1300 Points')">Buy Now</button>
                </div>
            </div>

            <div class="col">
                <div class="product-card text-center p-3 border border-warning">
                    <div class="product-image rounded-3 mb-3 bg-warning-subtle text-dark">
                        <i class="fas fa-trophy"></i>
                    </div>
                    <h5 class="fw-bold text-warning">PUBG Mobile</h5>
                    <p class="text-muted">3000 UC (Bonus Offer)</p>
                    <div class="price-tag mb-3">
                        <span class="pkr">PKR</span> 8,500
                    </div>
                    <button class="btn btn-primary-gaming w-100" data-product="PUBG_3000UC" onclick="purchaseProduct('PUBG 3000 UC')">Buy Now</button>
                </div>
            </div>

            <div class="col">
                <div class="product-card text-center p-3">
                    <div class="product-image rounded-3 mb-3">
                        <i class="fab fa-steam"></i>
                    </div>
                    <h5 class="fw-bold">Steam Wallet</h5>
                    <p class="text-muted">PKR 1000 Card</p>
                    <div class="price-tag mb-3">
                        <span class="pkr">PKR</span> 1,050
                    </div>
                    <button class="btn btn-primary-gaming w-100" data-product="STEAM_1000" onclick="purchaseProduct('Steam PKR 1000')">Buy Now</button>
                </div>
            </div>

            <div class="col">
                <div class="product-card text-center p-3 border border-info">
                    <div class="product-image rounded-3 mb-3 bg-info-subtle text-dark">
                        <i class="fas fa-star"></i>
                    </div>
                    <h5 class="fw-bold text-info">COD Mobile</h5>
                    <p class="text-muted">4000 CP Mega Pack</p>
                    <div class="price-tag mb-3">
                        <span class="pkr">PKR</span> 6,900
                    </div>
                    <button class="btn btn-primary-gaming w-100" data-product="CODM_4000CP" onclick="purchaseProduct('COD Mobile 4000 CP')">Buy Now</button>
                </div>
            </div>
            
             <div class="col">
                <div class="product-card text-center p-3">
                    <div class="product-image rounded-3 mb-3">
                        <i class="fas fa-dragon"></i>
                    </div>
                    <h5 class="fw-bold">League of Legends</h5>
                    <p class="text-muted">1380 Riot Points</p>
                    <div class="price-tag mb-3">
                        <span class="pkr">PKR</span> 3,000
                    </div>
                    <button class="btn btn-primary-gaming w-100" data-product="LOL_RP" onclick="purchaseProduct('LoL 1380 RP')">Buy Now</button>
                </div>
            </div>
            
             <div class="col">
                <div class="product-card text-center p-3">
                    <div class="product-image rounded-3 mb-3">
                        <i class="fas fa-bolt"></i>
                    </div>
                    <h5 class="fw-bold">Apex Legends</h5>
                    <p class="text-muted">2150 Apex Coins</p>
                    <div class="price-tag mb-3">
                        <span class="pkr">PKR</span> 4,999
                    </div>
                    <button class="btn btn-primary-gaming w-100" data-product="APEX_COINS" onclick="purchaseProduct('Apex 2150 Coins')">Buy Now</button>
                </div>
            </div>

        </div>
    </main>

    <footer class="mt-5 p-4 text-center text-white-50" style="background-color: #1a1a25;">
        <div class="container">
            <p class="mb-0">&copy; 2025 Gamer's Vault PK. All prices in PKR. | Secure Checkout.</p>
            <p class="small">User ID: <span id="currentUserId">N/A</span></p>
        </div>
    </footer>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script type="module">
        // Using the minimum required imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, onSnapshot, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        const firebaseConfig = {
          apiKey: "AIzaSyCc5XENrJcFfqS7egvvgeHFFrAzas-myvw",
          authDomain: "talim-zia.firebaseapp.com",
          databaseURL: "https://talim-zia-default-rtdb.asia-southeast1.firebasedatabase.app",
          projectId: "talim-zia",
          storageBucket: "talim-zia.firebasestorage.app",
          messagingSenderId: "1031601706144",
          appId: "1:1031601706144:web:9f81e6272b51b97aae25c5",
          measurementId: "G-LBXFS9PB0Q"
        };
        
        // Global Firebase variables
        let app;
        let auth;
        let db;
        let currentUserId = null;
        const APP_ID = firebaseConfig.projectId; 
        
        // Set Firebase logging level to Debug
        setLogLevel('Debug');

        /**
         * Shows a customized modal message to the user instead of using alert().
         * @param {string} title - The title of the modal.
         * @param {string} body - The message body.
         */
        function showMessage(title, body) {
            const modalTitle = document.getElementById('statusModalLabel');
            const modalBody = document.getElementById('statusModalBody');

            if (modalTitle && modalBody) {
                modalTitle.textContent = title;
                modalBody.innerHTML = body;
                const statusModal = new bootstrap.Modal(document.getElementById('statusModal'));
                statusModal.show();
            } else {
                console.error("Modal elements not found for display.");
            }
        }
        
        /**
         * Saves or updates the user's profile data in Firestore.
         * @param {object} userData - The data to save.
         */
        async function saveUserData(userData) {
            if (!db || !currentUserId || currentUserId === 'anonymous') {
                console.log("Cannot save data for unauthenticated or anonymous user.");
                return;
            }
            
            const userDocRef = doc(db, 
                `artifacts/${APP_ID}/users/${currentUserId}/profile`, 
                'user_data'
            );

            try {
                await setDoc(userDocRef, userData, { merge: true });
                console.log("User data successfully saved to Firestore.");
            } catch (error) {
                console.error("Error writing user data to Firestore:", error);
                showMessage("Database Error", "Failed to save your profile data. Please try again.");
            }
        }
        
        /**
         * Loads and displays user profile data (if any).
         */
        function loadUserData() {
            if (!db || !currentUserId || currentUserId === 'anonymous') {
                 console.log("Skipping data load for anonymous user.");
                 return;
            }

            const userDocRef = doc(db, 
                `artifacts/${APP_ID}/users/${currentUserId}/profile`, 
                'user_data'
            );

            // Using onSnapshot for real-time profile updates 
            onSnapshot(userDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    console.log("User Data Loaded:", data);
                    // Update UI with loaded data if needed (e.g., last login, name)
                } else {
                    console.log("No profile data found, creating new profile stub.");
                    // Check if auth.currentUser exists before accessing its email
                    if(auth.currentUser) {
                         saveUserData({
                            created: new Date().toISOString(),
                            lastLogin: new Date().toISOString(),
                            email: auth.currentUser.email || 'N/A'
                        });
                    }
                }
            }, (error) => {
                console.error("Error listening to user data:", error);
            });
        }


        /**
         * Handles Google Sign-In via popup.
         */
        async function signInWithGoogle() {
            if (!auth) {
                console.error("Firebase Auth not initialized.");
                return;
            }
            const provider = new GoogleAuthProvider();
            try {
                const result = await signInWithPopup(auth, provider);
                // The signed-in user info.
                const user = result.user;
                console.log("Google Sign-In successful for:", user.displayName);
                
                // Immediately save/update profile data upon sign-in
                await saveUserData({
                    name: user.displayName,
                    email: user.email,
                    photoURL: user.photoURL,
                    lastLogin: new Date().toISOString(),
                });

                showMessage("Welcome, Commander!", 
                    `<p>You are now signed in as <strong>${user.displayName}</strong>.</p>
                     <p>Your account data is secured in the cloud.</p>`
                );

            } catch (error) {
                console.error("Google Sign-In error:", error);
                // Handle errors like popup closed by user
                showMessage("Sign In Failed", 
                    `<p>There was an error during Google Sign-In.</p>
                     <p class="small text-danger">Error: ${error.message.substring(0, 100)}</p>`
                );
            }
        }

        /**
         * Signs out the current user.
         */
        async function signOutUser() {
            if (!auth) return;
            try {
                await signOut(auth);
                console.log("User signed out.");
                showMessage("Logout Success", "You have been successfully signed out. You can sign in again anytime.");
                // Note: onAuthStateChanged listener handles UI updates
            } catch (error) {
                console.error("Sign Out Error:", error);
                showMessage("Error", "Could not log out successfully.");
            }
        }
        
        /**
         * Master authentication handler tied to the navbar button.
         */
        window.handleAuth = function() {
            if (auth.currentUser && !auth.currentUser.isAnonymous) {
                signOutUser();
            } else {
                signInWithGoogle();
            }
        }
        
        /**
         * Updates the UI based on the current user state.
         * @param {object | null} user - The current Firebase user object.
         */
        function updateAuthUI(user) {
            const authButton = document.getElementById('authButton');
            const welcomeMessage = document.getElementById('welcomeMessage');
            const userIdSpan = document.getElementById('currentUserId');

            if (user) {
                currentUserId = user.uid;
                userIdSpan.textContent = user.uid;
                if (user.isAnonymous) {
                    authButton.innerHTML = '<i class="fab fa-google"></i> Sign In (Anonymous)';
                    authButton.classList.remove('btn-danger');
                    authButton.classList.add('btn-primary-gaming');
                    welcomeMessage.innerHTML = `Welcome back! Please sign in with Google to secure your history.`;
                    console.log("User is signed in anonymously. UID:", user.uid);
                } else {
                    authButton.innerHTML = '<i class="fas fa-sign-out-alt"></i> Sign Out';
                    authButton.classList.remove('btn-primary-gaming');
                    authButton.classList.add('btn-danger');
                    welcomeMessage.innerHTML = `Signed in as <strong>${user.displayName || user.email}</strong>. Welcome to the Vault!`;
                    console.log("User is fully authenticated. UID:", user.uid);
                    loadUserData(); // Start listening for user data after successful sign-in
                }
            } else {
                currentUserId = null;
                userIdSpan.textContent = 'N/A (Signed Out)';
                authButton.innerHTML = '<i class="fab fa-google"></i> Sign In';
                authButton.classList.remove('btn-danger');
                authButton.classList.add('btn-primary-gaming');
                welcomeMessage.innerHTML = 'Connect your Google account to save your purchase history!';
                console.log("No user is signed in.");
            }
        }

        /**
         * Handles the click of a product card's Buy Now button.
         * @param {string} productName - The name of the product purchased.
         */
        window.purchaseProduct = function(productName) {
            if (!currentUserId) {
                showMessage("Purchase Alert", 
                    `<p>You must sign in first to complete a purchase!</p>
                     <p>Click the <strong>Sign In</strong> button to proceed with Google.</p>`
                );
                return;
            }

            const isAnonymous = auth.currentUser && auth.currentUser.isAnonymous;
            const statusText = isAnonymous 
                ? "Your order is placed under your temporary ID and will be saved permanently if you sign in with Google."
                : "Your order details will be saved to your purchase history.";

            // Save the purchase event to a 'transactions' collection
            const transactionsColRef = collection(db, 
                `artifacts/${APP_ID}/users/${currentUserId}/transactions`
            );

            const transactionData = {
                userId: currentUserId,
                product: productName,
                timestamp: new Date().toISOString(),
                status: 'Pending',
                isAnonymous: isAnonymous
            };
            

            // Add the document to the transactions subcollection
            addDoc(transactionsColRef, transactionData)
                .then(() => {
                    showMessage("Order Placed!", 
                        `<p>Thank you for purchasing <strong>${productName}</strong>!</p>
                         <p>We are processing your order. ${statusText}</p>`
                    );
                })
                .catch(error => {
                    console.error("Error recording transaction:", error);
                    showMessage("Order Error", 
                        `<p>Failed to record your purchase in the database.</p>
                         <p class="small text-danger">Error: ${error.message.substring(0, 100)}</p>`
                    );
                });
        }


        // --- Initialization Logic ---
        document.addEventListener('DOMContentLoaded', async () => {
            if (!firebaseConfig) {
                showMessage("Configuration Error", "Firebase configuration is missing. The application cannot function without it.");
                return;
            }

            try {
                // Initialize Firebase
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // Set up the state change listener immediately
                onAuthStateChanged(auth, (user) => {
                    updateAuthUI(user);
                });

                // Check for existing user, if none, attempt anonymous sign-in
                if (!auth.currentUser) {
                    await signInAnonymously(auth);
                }
                
            } catch (error) {
                console.error("Critical Firebase Initialization or Auth Error:", error);
                showMessage("Initialization Error", 
                    `<p>Could not connect to the database or authenticate.</p>
                     <p class="small text-danger">Error: ${error.message.substring(0, 100)}</p>`
                );
            }
        });

    </script>
</body>
</html>